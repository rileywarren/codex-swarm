# Codex Native Tool Patch Guide

Generated by `codex-swarm patch` (deterministic output)

This guide explains how to add native `spawn_agent` support to a Codex fork while keeping orchestration in `codex-swarm`.

## Preconditions

1. Run Codex under `codex-swarm`.
2. Ensure `CODEX_SWARM_SOCKET` is exported.
3. Keep a clean branch in your Codex fork before patching.

## 1. Add Tool Definition

Locate the tools array in the agent loop and add a function tool:

```ts
{
  name: "spawn_agent",
  description: "Delegate a focused task to codex-swarm worker",
  parameters: {
    type: "object",
    properties: {
      task: { type: "string" },
      scope: { type: "array", items: { type: "string" } },
      context: { type: "string" }
    },
    required: ["task"]
  }
}
```

## 2. Add Tool Handler

In the tool execution switch:

```ts
case "spawn_agent": {
  const socketPath = process.env.CODEX_SWARM_SOCKET;
  if (!socketPath) {
    return { error: "CODEX_SWARM_SOCKET is not set. Run under codex-swarm." };
  }

  const payload = {
    type: "spawn_agent",
    payload: args,
    id: crypto.randomUUID(),
    timestamp: new Date().toISOString(),
    reply_to: null,
  };

  const response = await callSwarmSocket(socketPath, payload);
  return response.payload;
}
```

## 3. Add Socket Helper

Implement a helper that:

1. Connects to Unix socket path.
2. Sends JSON + `\n---MSG_END---\n` terminator.
3. Waits for reply with matching `reply_to`.
4. Handles timeout and malformed response errors.

## 4. Environment Awareness

Return a clear error when `CODEX_SWARM_SOCKET` is missing or connection fails.

## 5. Validation Checklist

1. Start `codex-swarm` and confirm socket file exists.
2. Run patched Codex and invoke `spawn_agent`.
3. Verify tool call blocks until worker response arrives.
4. Verify errors are surfaced for timeout/socket disconnect.

## Notes

- This guide intentionally does not auto-modify any Codex installation.
- Keep patch commits small and isolated for easier rebasing.
